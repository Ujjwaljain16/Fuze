name: Sync Backend to Hugging Face Space

on:
  push:
    branches:
      - main
    paths:
      - 'backend/**'
      - 'requirements.txt'
      - 'Dockerfile'
      - 'app.py'
      - 'wsgi.py'
      - 'start.sh'

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout main repo
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Setup Git
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"

      - name: Clone HF Space
        env:
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
        run: |
          git clone https://huggingface:$HF_TOKEN@huggingface.co/spaces/Ujjwaljain16/fuze-backend hf-space
          cd hf-space
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"

      - name: Sync Backend Files
        run: |
          # Copy backend files
          cp -r backend hf-space/
          cp requirements.txt hf-space/
          cp Dockerfile hf-space/
          cp app.py hf-space/
          cp wsgi.py hf-space/
          cp start.sh hf-space/

      - name: Commit and Push to HF Space
        env:
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
        run: |
          cd hf-space
          git add .
          git diff --staged --quiet || git commit -m "chore: auto-sync from main repo [skip ci]"
          # Get current branch name (HF Spaces might use 'main' or 'master')
          BRANCH=$(git branch --show-current || echo "main")
          # Configure git to use the token
          git remote set-url origin https://huggingface:$HF_TOKEN@huggingface.co/spaces/Ujjwaljain16/fuze-backend
          # Push changes
          git push origin HEAD:$BRANCH